import React, {useEffect, useRef, useState} from 'react';
import styled from "styled-components";
import {ModalBody, ModalContainer, ModalHeader, ModalWrapper} from "../../container/Modal";
import {
    dark,
    primary,
    color,
    inputBackgroundColor
} from "../../misc/Theme";
import {calculatedCosts, useOutsideAlerter} from "../../helpers";
import Profile from "./Profile";
import Salary from "./Salary";
import BusinessCosts from "./BusinessCosts";
import WorkinHours from "./WorkingHours";
import {connect} from "react-redux";

const Controls = styled.div`
    display: flex;
    align-items: center;
    border-bottom: 1px solid rgba(${dark}, .2);
    
    span {
        color: rgba(${color}, .2);
        padding: 16px;
        border-bottom: 2px solid transparent;
        &:hover,
        &:active,
        &.current{
            color: rgba(${primary}, 1);
            border-bottom: 2px solid rgba(${primary}, 1);
        }
    }
`;

const Header = styled.div`
    background: ${inputBackgroundColor};
    padding: 16px;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-around;
`;

const Group = styled.div`
    display: flex;
    align-items: center;
    color: rgba(${color}, .2);
    
    strong{
        font-weight: normal;
        font-size: 1.4rem;
        color: rgba(${color}, .7);
    }
`;

const Circle = styled.div`
    height: 70px;
    width: 70px;
    background: white;
    border-radius: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
    
    svg{
        display: block;
        width: 50%;
        height: auto;
    }
`;

const SettingsModal = ({open, settings, toggle, update_expenses}) => {

    const elem = useRef();
    const views = {
        profile: (<Profile/>),
        salary: (<Salary/>),
        businessCosts: (<BusinessCosts/>),
        workingHours: (<WorkinHours/>),
    };

    const {expenses} = settings;
    const [view, setView] = useState('profile');
    const [render, setRender] = useState(null);
    const [annualBusinessCosts, setAnnualBusinessCosts] = useState(0);
    const [annualWorkingHours, setAnnualWorkingHours] = useState(0);

    useEffect(() => {
        setRender(views[view])
    }, [view]);

    useEffect(() => {

        const costs = calculatedCosts(expenses);
        setAnnualBusinessCosts(costs.AnnualBusinessCosts);
        setAnnualWorkingHours(costs.AnnualWorkingHours);


    }, [expenses]);

    useEffect(() => {
        const breakEven = Math.round(annualBusinessCosts / annualWorkingHours);

        if(breakEven !== null){
            update_expenses({
                key: 'breakEven',
                value: breakEven
            });

            update_expenses({
                key: 'profit10',
                value: Math.round(breakEven + (breakEven * (10 / 100)))
            });

            update_expenses({
                key: 'profit20',
                value: Math.round(breakEven + (breakEven * (20 / 100)))
            });
        }
    }, [
        annualBusinessCosts,
        annualWorkingHours
    ]);

    useOutsideAlerter(elem, open, () => {
        toggle();
    });

    return open ? (
        <ModalWrapper>
            <ModalContainer
                ref={elem}
                animate={{
                    opacity: 1,
                    margin: '10vh auto auto auto'
                }}
                style={{maxWidth: 700, borderRadius: 8}}
            >
                <ModalHeader style={{padding: 16, borderTopLeftRadius: 8, borderTopRightRadius: 8}} justify={'space-between'} color={`rgba(${primary}, 1)`}>
                    <div>
                        Profile & Settings
                    </div>

                </ModalHeader>
                <ModalBody style={{overflow: 'visible', padding: 0}}>
                    <Header>
                        <Group>
                            <Circle>
                                <svg viewBox="0 0 512 512"><path d="m168 24h320v440h-320z" fill="#65dcff"/><path d="m200 56h80v32h-80z" fill="#a0cc00"/><path d="m200 152h256v32h-256z" fill="#3d9de6"/><path d="m72 248h192v288h-192z" fill="#3ea7ff" transform="matrix(0 -1 1 0 -224 560)"/><path d="m68 332h48v56h-48z" fill="#f2e368" transform="matrix(0 -1 1 0 -268 452)"/><circle cx="256" cy="432" fill="#fc7" r="24"/><circle cx="216" cy="432" fill="#eb352f" r="24"/><path d="m24 496h288a7.99977 7.99977 0 0 0 8-8v-192a7.99977 7.99977 0 0 0 -8-8h-288a7.99977 7.99977 0 0 0 -8 8v192a7.99977 7.99977 0 0 0 8 8zm8-192h272v176h-272z"/><path d="m64 392h56a7.99977 7.99977 0 0 0 8-8v-48a7.99977 7.99977 0 0 0 -8-8h-56a7.99977 7.99977 0 0 0 -8 8v48a7.99977 7.99977 0 0 0 8 8zm8-48h40v32h-40z"/><path d="m48 408h16v16h-16z"/><path d="m80 408h16v16h-16z"/><path d="m112 408h16v16h-16z"/><path d="m144 408h16v16h-16z"/><path d="m48 440h48v16h-48z"/><path d="m112 440h32v16h-32z"/><path d="m256 400a31.92888 31.92888 0 0 0 -20 7.01611 32 32 0 1 0 0 49.96778 32.00126 32.00126 0 1 0 20-56.98389zm0 48a15.98554 15.98554 0 0 1 -13.3374-7.16309 7.99932 7.99932 0 0 0 -13.3252 0 16 16 0 1 1 0-17.67382 7.99932 7.99932 0 0 0 13.3252 0 15.9997 15.9997 0 1 1 13.3374 24.83691z"/><path d="m488 16h-320a7.99977 7.99977 0 0 0 -8 8v248h16v-240h304v424h-144v16h152a7.99977 7.99977 0 0 0 8-8v-440a7.99977 7.99977 0 0 0 -8-8z"/><path d="m192 184a7.99977 7.99977 0 0 0 8 8h16v80h16v-80h64v80h16v-80h40v104h16v-104h40v104h16v-104h32a7.99977 7.99977 0 0 0 8-8v-32a7.99977 7.99977 0 0 0 -8-8h-256a7.99977 7.99977 0 0 0 -8 8zm16-24h240v16h-240z"/><path d="m336 312h128v16h-128z"/><path d="m408 344h56v16h-56z"/><path d="m200 96h80a7.99977 7.99977 0 0 0 8-8v-32a7.99977 7.99977 0 0 0 -8-8h-80a7.99977 7.99977 0 0 0 -8 8v32a7.99977 7.99977 0 0 0 8 8zm8-32h64v16h-64z"/><path d="m368 48h48v16h-48z"/><path d="m432 48h32v16h-32z"/><path d="m368 80h32v16h-32z"/><path d="m416 80h32v16h-32z"/><path d="m320 112h16v16h-16z"/><path d="m352 112h16v16h-16z"/><path d="m384 112h32v16h-32z"/><path d="m336 392h48v16h-48z"/><path d="m400 392h32v16h-32z"/><path d="m336 424h96v16h-96z"/></svg>
                            </Circle>
                            <div>
                                <small style={{display: 'block'}}>Annual Business Costs</small>
                                <strong>{annualBusinessCosts}$</strong>
                            </div>
                        </Group>

                        <Group>
                            <Circle>
                                <svg viewBox="0 0 512 512"><path d="m446.277 203.312v44.311c0 21.46-11.543 41.261-30.216 51.835-18.9 10.73-42.047 10.743-60.959.034l-.06-.034c-18.674-10.574-30.216-30.375-30.216-51.835v-40.258z" fill="#fed2a4"/><path d="m385.495 146.667c-33.495 0-60.648 27.175-60.648 60.697l-.02 12.405h74.924c17.383-2.928 33.069-12.182 44.039-25.98l.63-.792c-6.451-26.584-30.378-46.33-58.925-46.33z" fill="#ffbe52"/><path d="m10 461.972h492v40h-492z" fill="#ffbe52"/><path d="m502 461.972v-38.009c0-64.313-52.136-116.448-116.448-116.448-39.008 0-73.536 19.18-94.668 48.623-13.709 19.1-21.78 42.52-21.78 67.825v38.009z" fill="#ff765b"/><path d="m269.104 299.002h-193.471c-7.439 0-12.965 6.889-11.351 14.15l33.071 148.82h217.294l-34.192-153.865c-1.183-5.32-5.901-9.105-11.351-9.105z" fill="#009fff"/><circle cx="128" cy="127.972" fill="#93e7f8" r="118"/><path d="m426.843 304.445c18.31-12.943 29.434-34.135 29.434-56.822v-44.311c0-1.082-.177-2.121-.494-3.096-3.593-35.638-33.744-63.548-70.288-63.548-38.689 0-70.198 31.286-70.628 69.901-.021.263-.04.527-.04.796v40.258c0 22.71 11.147 43.921 29.49 56.861-17.872 6.19-34.26 16.337-47.813 29.747l-6.287-28.292c-2.215-9.972-10.897-16.937-21.113-16.937h-193.471c-6.595 0-12.744 2.95-16.871 8.095s-5.673 11.787-4.242 18.225l30.367 136.651h-74.887c-5.523 0-10 4.478-10 10v40c0 5.522 4.477 10 10 10h492c5.523 0 10-4.478 10-10v-40-38.009c0-55.271-35.648-102.366-85.157-119.519zm-41.348-147.777c21.778 0 40.386 13.83 47.527 33.176-.034.033-.071.062-.104.096-12.413 12.603-29.677 19.831-47.366 19.831h-50.726v-2.009c.005-.133.02-.263.02-.396 0-27.955 22.721-50.698 50.649-50.698zm-50.669 90.955v-17.853h50.726c18.21 0 36.062-5.908 50.726-16.492v34.344c0 17.823-9.635 34.352-25.153 43.14-15.753 8.942-35.331 8.955-51.094.028-.019-.011-.061-.034-.098-.055-15.488-8.788-25.107-25.304-25.107-43.112zm50.726 69.892c58.696 0 106.448 47.753 106.448 106.448v28.009h-169.332l-20.833-93.749c20.118-25.558 51.11-40.708 83.717-40.708zm-303.06 31.487h105.701c5.523 0 10-4.478 10-10s-4.477-10-10-10h-110.145l-4.004-18.019c-.14-.631.097-1.094.319-1.372.223-.278.625-.609 1.27-.609h193.471c.769 0 1.422.524 1.589 1.274l31.488 141.696h-196.807zm409.508 142.97h-472v-20h77.353 217.294 177.353z"/><path d="m228.19 329.003c-2.63 0-5.21 1.069-7.07 2.93-1.86 1.859-2.93 4.439-2.93 7.07 0 2.63 1.07 5.21 2.93 7.069 1.86 1.86 4.44 2.931 7.07 2.931s5.21-1.07 7.08-2.931c1.86-1.859 2.92-4.439 2.92-7.069 0-2.631-1.06-5.211-2.92-7.07-1.87-1.861-4.44-2.93-7.08-2.93z"/><path d="m128 255.972c34.19 0 66.334-13.314 90.51-37.49 38.094-38.094 48.258-96.412 25.292-145.117-2.355-4.996-8.315-7.135-13.31-4.78-4.996 2.355-7.136 8.314-4.78 13.31 19.377 41.095 10.799 90.302-21.345 122.445-20.398 20.398-47.519 31.633-76.367 31.633s-55.969-11.234-76.367-31.633c-42.109-42.109-42.109-110.625 0-152.734 31.932-31.934 80.899-40.625 121.845-21.626 5.009 2.323 10.955.147 13.28-4.862 2.324-5.01.147-10.956-4.862-13.28-48.529-22.516-106.562-12.219-144.406 25.624-49.907 49.907-49.907 131.112 0 181.02 24.177 24.176 56.32 37.49 90.51 37.49z"/><path d="m204.562 138.068h7.263c5.523 0 10-4.478 10-10s-4.477-10-10-10h-7.263c-5.523 0-10 4.478-10 10s4.477 10 10 10z"/><path d="m44.175 117.877c-5.523 0-10 4.478-10 10s4.477 10 10 10h7.263c5.523 0 10-4.478 10-10s-4.477-10-10-10z"/><path d="m117.904 204.534v7.264c0 5.522 4.477 10 10 10s10-4.478 10-10v-7.264c0-5.522-4.477-10-10-10s-10 4.477-10 10z"/><path d="m151.999 160.972c2.631 0 5.257-1.032 7.221-3.081 3.821-3.987 3.687-10.317-.301-14.139l-20.914-20.042.09-71.956c.007-5.523-4.464-10.006-9.987-10.013-.004 0-.009 0-.013 0-5.517 0-9.993 4.469-10 9.987l-.095 76.232c-.003 2.73 1.11 5.344 3.081 7.232l24 23c1.938 1.857 4.43 2.78 6.918 2.78z"/><path d="m211.44 54.532c2.63 0 5.21-1.069 7.07-2.93s2.93-4.44 2.93-7.07-1.07-5.21-2.93-7.069c-1.86-1.86-4.44-2.931-7.07-2.931s-5.21 1.07-7.07 2.931c-1.86 1.859-2.93 4.439-2.93 7.069s1.07 5.21 2.93 7.07 4.44 2.93 7.07 2.93z"/></svg>
                            </Circle>
                            <div>
                                <small style={{display: 'block'}}>Available working hours</small>
                                <strong>{annualWorkingHours}h</strong>
                            </div>
                        </Group>

                        <Group>
                            <Circle>
                                <svg viewBox="0 0 512 512"><path d="m212.907 142.121h-56.687l-51.175-73.92c-10.716-15.478.362-36.621 19.188-36.621h120.662c18.825 0 29.903 21.143 19.188 36.621z" fill="#48cfb7"/><path d="m244.895 31.58h-29.773c14.934 0 23.722 21.143 15.222 36.622l-40.597 73.919h23.161l51.175-73.919c10.715-15.479-.363-36.622-19.188-36.622z" fill="#35b5a0"/><path d="m156.22 142.121-133.078 196.435c-10.194 15.046-15.642 32.803-15.642 50.977 0 50.196 40.692 90.887 90.887 90.887h172.352c50.196 0 90.887-40.692 90.887-90.887 0-18.174-5.448-35.93-15.642-50.976l-133.077-196.436z" fill="#48cfb7"/><path d="m345.985 338.556-133.078-196.435h-33.734l133.078 196.436c10.193 15.046 15.642 32.803 15.642 50.977 0 50.196-40.692 90.888-90.887 90.888h33.734c50.196 0 90.887-40.692 90.887-90.888 0-18.175-5.449-35.931-15.642-50.978z" fill="#35b5a0"/><circle cx="393.083" cy="369.004" fill="#fcab29" r="111.417"/><path d="m460.627 280.397c17.115 19.588 27.488 45.218 27.488 73.273 0 61.533-49.883 111.417-111.417 111.417-25.397 0-48.804-8.503-67.543-22.81 20.424 23.375 50.45 38.144 83.928 38.144 61.534 0 111.417-49.884 111.417-111.417 0-36.138-17.209-68.25-43.873-88.607z" fill="#dd8d19"/><circle cx="393.083" cy="369.004" fill="#f2df33" r="80.173"/><path d="m54.754 149.62h87.326l-29.633 43.741c-2.323 3.429-1.426 8.092 2.003 10.415 3.43 2.322 8.093 1.427 10.416-2.003l35.332-52.153h48.731l81.4 120.155c1.45 2.14 3.812 3.294 6.216 3.294 1.448 0 2.911-.419 4.2-1.292 3.429-2.323 4.326-6.986 2.003-10.415l-80.751-119.196 48.252-69.697c6.55-9.462 7.301-21.671 1.96-31.864s-15.807-16.525-27.314-16.525h-120.663c-11.508 0-21.974 6.332-27.315 16.525s-4.59 22.402 1.96 31.865l31.663 45.734-63.876-37.808c-3.565-2.109-8.164-.93-10.274 2.634s-.931 8.165 2.634 10.274l69.801 41.315h-74.07c-4.142 0-7.5 3.357-7.5 7.5s3.357 7.501 7.499 7.501zm55.45-102.053c2.785-5.314 8.029-8.487 14.028-8.487h120.662c6 0 11.244 3.173 14.028 8.487 2.785 5.313 2.408 11.432-1.007 16.364l-48.938 70.688h-48.828l-48.938-70.688c-3.415-4.932-3.792-11.05-1.007-16.364z"/><path d="m393.083 250.087c-65.571 0-118.917 53.346-118.917 118.917 0 36.209 16.273 68.685 41.883 90.514-13.427 8.683-29.198 13.402-45.309 13.402h-172.35c-22.276 0-43.217-8.674-58.967-24.424-15.749-15.749-24.423-36.69-24.423-58.966 0-16.737 4.962-32.908 14.349-46.764l78.52-115.899c2.323-3.43 1.427-8.093-2.002-10.416-3.429-2.322-8.093-1.427-10.416 2.002l-78.52 115.899c-11.077 16.349-16.931 35.429-16.931 55.178 0 26.282 10.234 50.99 28.817 69.573 18.582 18.582 43.291 28.816 69.573 28.816h172.35c20.862 0 41.245-6.703 58.015-18.945 18.557 11.982 40.644 18.945 64.328 18.945 65.571.001 118.917-53.345 118.917-118.915 0-65.571-53.346-118.917-118.917-118.917zm0 222.833c-57.3 0-103.917-46.616-103.917-103.916s46.617-103.917 103.917-103.917 103.917 46.617 103.917 103.917-46.617 103.916-103.917 103.916z"/><path d="m470.074 327.032c-1.986-3.635-6.542-4.972-10.177-2.986-3.635 1.985-4.973 6.542-2.987 10.178 5.787 10.595 8.846 22.621 8.846 34.78 0 40.072-32.601 72.673-72.673 72.673s-72.673-32.601-72.673-72.673 32.601-72.673 72.673-72.673c16.979 0 33.497 5.978 46.512 16.831 3.181 2.653 7.911 2.224 10.563-.956 2.653-3.182 2.225-7.911-.956-10.563-15.706-13.098-35.636-20.312-56.119-20.312-48.343 0-87.673 39.33-87.673 87.673s39.33 87.673 87.673 87.673 87.673-39.33 87.673-87.673c0-14.664-3.693-29.178-10.682-41.972z"/><path d="m393.083 426.906c4.142 0 7.5-3.357 7.5-7.5v-7.827h2.454c13.806 0 25.038-11.232 25.038-25.038s-11.232-25.037-25.038-25.037h-19.908c-5.535 0-10.038-4.503-10.038-10.038s4.503-10.038 10.038-10.038h29.192c4.142 0 7.5-3.357 7.5-7.5s-3.358-7.5-7.5-7.5h-11.738v-7.827c0-4.143-3.358-7.5-7.5-7.5s-7.5 3.357-7.5 7.5v7.827h-2.454c-13.806 0-25.038 11.232-25.038 25.038s11.232 25.038 25.038 25.038h19.908c5.535 0 10.038 4.503 10.038 10.037 0 5.535-4.503 10.038-10.038 10.038h-29.192c-4.142 0-7.5 3.357-7.5 7.5s3.358 7.5 7.5 7.5h11.739v7.827c-.001 4.143 3.357 7.5 7.499 7.5z"/><path d="m332.578 156.935 5.861-4.688v68.76c0 4.143 3.358 7.5 7.5 7.5s7.5-3.357 7.5-7.5v-68.76l5.861 4.688c1.383 1.106 3.037 1.644 4.68 1.644 2.2 0 4.38-.963 5.861-2.814 2.588-3.235 2.063-7.954-1.171-10.542l-18.046-14.437c-.019-.016-.042-.025-.061-.041-.315-.248-.648-.473-1.001-.668-.007-.003-.013-.008-.02-.012-.339-.186-.696-.339-1.064-.472-.05-.018-.1-.038-.15-.055-.347-.116-.704-.207-1.071-.272-.065-.011-.129-.02-.193-.029-.368-.056-.741-.093-1.124-.093s-.756.038-1.124.093c-.065.01-.129.018-.193.029-.367.065-.725.156-1.071.272-.051.017-.1.037-.15.055-.368.132-.725.286-1.064.472-.007.004-.013.009-.02.012-.353.195-.686.421-1.001.668-.02.016-.042.025-.061.041l-18.046 14.437c-3.234 2.588-3.759 7.307-1.171 10.542 2.585 3.232 7.303 3.757 10.539 1.17z"/><path d="m426.867 116.712 5.861-4.688v68.76c0 4.143 3.358 7.5 7.5 7.5s7.5-3.357 7.5-7.5v-68.76l5.861 4.688c1.383 1.106 3.037 1.644 4.68 1.644 2.2 0 4.38-.963 5.861-2.814 2.588-3.235 2.063-7.954-1.171-10.542l-18.046-14.437c-.019-.016-.042-.025-.061-.041-.315-.248-.648-.473-1.001-.668-.007-.003-.013-.008-.02-.012-.339-.186-.696-.339-1.064-.472-.05-.018-.1-.038-.15-.055-.347-.116-.704-.207-1.071-.272-.065-.011-.129-.02-.193-.029-.368-.056-.741-.093-1.124-.093s-.756.038-1.124.093c-.065.01-.129.018-.193.029-.367.065-.725.156-1.071.272-.051.017-.1.037-.15.055-.368.132-.725.286-1.064.472-.007.004-.013.009-.02.012-.353.195-.686.421-1.001.668-.02.016-.042.025-.061.041l-18.046 14.437c-3.234 2.588-3.759 7.307-1.171 10.542 2.585 3.232 7.304 3.757 10.539 1.17z"/></svg>
                            </Circle>
                            <div>
                                <small style={{display: 'block'}}>Recommended Hourly Rate</small>
                                <strong>{expenses.profit10 !== null ? expenses.profit10.toFixed(2) : (0).toFixed(2)}$</strong>
                            </div>
                        </Group>
                    </Header>
                    <Controls>
                        <span className={view === 'profile' ? 'current' : null} onClick={() => setView('profile')}>
                            Profile
                        </span>
                        <span className={view === 'salary' ? 'current' : null} onClick={() => setView('salary')}>
                            Annual Salary
                        </span>
                        <span className={view === 'businessCosts' ? 'current' : null} onClick={() => setView('businessCosts')}>
                            Annual Business Costs
                        </span>
                        <span className={view === 'workingHours' ? 'current' : null} onClick={() => setView('workingHours')}>
                            Annual Working Hours
                        </span>
                    </Controls>

                    {render}
                </ModalBody>
            </ModalContainer>
        </ModalWrapper>
    ) : null;
};

const mapStateToProps = state => ({
    settings: state.settings
});

const mapDispatchToProps = dispatch => ({
    update_expenses: expenses => dispatch({
        type: 'UPDATE_EXPENSES',
        payload: expenses
    })
});

export default connect(mapStateToProps, mapDispatchToProps)(SettingsModal);