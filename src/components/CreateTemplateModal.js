import React, {useRef, useState} from 'react';
import styled from "styled-components";
import {ModalBody, ModalContainer, ModalHeader, ModalWrapper} from "../container/Modal";
import {Button, Input, Label} from "../misc/Form";
import {uid, useOutsideAlerter} from "../helpers";
import {connect} from "react-redux";
import {color, primary} from "../misc/Theme";

const Columns = styled.div`
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    align-items: center;
    svg{
    
        height: 100px;
        width: auto;
        display: block;
        margin: 0px 40px auto 20px;
    }
    form{
        flex: 1;
    }
`;

const CreateTemplateModal = ({add_template, id, checklists, boards, tasks, projects, open, toggle}) => {
    const elem = useRef();
    const [name, setName] = useState('');

    useOutsideAlerter(elem, open, () => {
        setName('');
        toggle();
    });

    const submitBoard = (e) => {
        e.preventDefault();

        const template = {
            id: uid(),
            name: name,
            project: {
                ...projects.find(project => project.id === id)
            },
            boards: [
                ...boards.filter(board => board.project === id)
            ],
            tasks: [
                ...tasks.filter(task => task.project === id).map(task => {
                    return {
                        ...task,
                        checklists: [
                            ...checklists.filter(list => list.parent === task.id)
                        ]
                    }
                })
            ]
        };
        add_template(template);

        setName('');
        toggle();
    };

    return open ? (
        <ModalWrapper>
            <ModalContainer
                ref={elem}
                animate={{
                    opacity: 1,
                    margin: '10vh auto auto auto'
                }}
            >
                <ModalHeader
                    color={`rgba(${primary})`}
                >
                    <span>saving as template ...</span>
                </ModalHeader>
                <ModalBody
                    style={{overflow: 'visible', minHeight: 100}}
                >
                    <Columns>
                        <div>
                            <svg viewBox="1 1 596.718 596.718"><path d="m527.347656 557.199219c0 16.488281-13.363281 29.851562-29.847656 29.851562h-398c-16.488281 0-29.851562-13.363281-29.851562-29.851562v-517.398438c0-16.488281 13.363281-29.851562 29.851562-29.851562h398c16.488281 0 29.851562 13.363281 29.851562 29.851562v517.398438zm0 0" fill="#87ced9"/><path d="m497.5 587.050781h-457.699219c-16.488281 0-29.851562-13.363281-29.851562-29.851562v-29.851563h457.699219v29.851563c0 16.488281 13.363281 29.851562 29.851562 29.851562zm0 0" fill="#4398d1"/><path d="m9.949219 169.148438h199v119.402343h-199zm0 0" fill="#fda72f"/><path d="m62.617188 248.980469-19.902344-19.902344c-3.878906-3.878906-3.878906-10.1875 0-14.070313l19.902344-19.898437 14.066406 14.070313-12.863282 12.863281 12.863282 12.863281zm0 0" fill="#ff8a3d"/><path d="m156.285156 248.980469-14.070312-14.070313 12.867187-12.867187-12.867187-12.863281 14.070312-14.070313 19.898438 19.898437c3.882812 3.882813 3.882812 10.191407 0 14.070313zm0 0" fill="#ff8a3d"/><path d="m90.042969 248.75 19.914062-59.695312 18.875 6.296874-19.910156 59.695313zm0 0" fill="#ff8a3d"/><path d="m248.75 69.648438h338.300781v199h-338.300781zm0 0" fill="#4398d1"/><path d="m587.050781 228.851562-69.652343-39.800781-76.832032 39.800781-92.316406-59.703124-99.5 59.703124v39.796876h338.300781zm0 0" fill="#3269a1"/><path d="m497.5 134.324219c0 13.738281-11.136719 24.875-24.875 24.875s-24.875-11.136719-24.875-24.875 11.136719-24.875 24.875-24.875 24.875 11.136719 24.875 24.875zm0 0" fill="#e34b87"/><path d="m109.449219 328.351562h248.75v119.398438h-248.75zm0 0" fill="#e34b87"/><g fill="#bf3d75"><path d="m139.300781 358.199219h39.796875v19.902343h-39.796875zm0 0"/><path d="m199 358.199219h89.550781v19.902343h-89.550781zm0 0"/><path d="m308.449219 358.199219h19.902343v19.902343h-19.902343zm0 0"/><path d="m139.300781 398h119.398438v19.902344h-119.398438zm0 0"/><path d="m278.597656 398h49.75v19.902344h-49.75zm0 0"/></g><path d="m99.5 39.800781h19.902344v19.898438h-19.902344zm0 0" fill="#5eb3d1"/><path d="m139.300781 39.800781h19.898438v19.898438h-19.898438zm0 0" fill="#5eb3d1"/><path d="m179.097656 39.800781h19.902344v19.898438h-19.902344zm0 0" fill="#5eb3d1"/><path d="m99.5 79.597656h119.402344v19.902344h-119.402344zm0 0" fill="#5eb3d1"/><path d="m398 368.148438h189.050781v119.402343h-189.050781zm0 0" fill="#e34b87"/><path d="m427.851562 398h19.898438v19.902344h-19.898438zm0 0" fill="#bf3d75"/><path d="m427.851562 437.800781h19.898438v19.898438h-19.898438zm0 0" fill="#bf3d75"/><path d="m467.648438 398h89.550781v19.902344h-89.550781zm0 0" fill="#bf3d75"/><path d="m467.648438 437.800781h89.550781v19.898438h-89.550781zm0 0" fill="#bf3d75"/><path d="m268.648438 268.648438h258.703124v19.902343h-258.703124zm0 0" fill="#71c4d1"/><path d="m417.898438 487.550781h109.449218v19.898438h-109.449218zm0 0" fill="#71c4d1"/><path d="m208.949219 189.050781v99.5h-139.300781v19.898438h159.203124v-119.398438zm0 0" fill="#71c4d1"/><path d="m358.199219 348.25v99.5h-228.847657v19.898438h248.746094v-119.398438zm0 0" fill="#71c4d1"/><path d="m59.699219 39.800781v99.5h19.902343v-99.5c0-10.996093 8.902344-19.902343 19.898438-19.902343h398c10.996094 0 19.902344 8.90625 19.902344 19.902343h19.898437c0-21.980469-17.820312-39.800781-39.800781-39.800781h-398c-21.980469 0-39.800781 17.820312-39.800781 39.800781zm0 0"/><path d="m39.800781 597h457.699219c21.976562 0 39.796875-17.820312 39.796875-39.800781v-39.796875h-19.898437v39.796875c0 10.996093-8.90625 19.902343-19.902344 19.902343-10.992188 0-19.898438-8.90625-19.898438-19.902343v-29.851563c0-5.492187-4.457031-9.949218-9.949218-9.949218h-388.050782v-199h-19.898437v199h-49.75c-5.492188 0-9.949219 4.460937-9.949219 9.949218v29.851563c0 21.980469 17.820312 39.800781 39.800781 39.800781zm-19.898437-59.699219h437.796875v19.898438c-.007813 6.984375 1.832031 13.863281 5.34375 19.902343h-423.242188c-10.996093 0-19.902343-8.90625-19.902343-19.902343v-19.898438zm0 0"/><path d="m9.949219 298.5h199c5.492187 0 9.949219-4.457031 9.949219-9.949219v-119.402343c0-5.492188-4.457032-9.949219-9.949219-9.949219h-199c-5.492188 0-9.949219 4.457031-9.949219 9.949219v119.402343c0 5.492188 4.457031 9.949219 9.949219 9.949219zm9.953125-119.402344h179.097656v99.5h-179.097656zm0 0"/><path d="m62.617188 201.914062-19.902344 19.902344c-3.878906 3.878906-3.878906 10.1875 0 14.066406l19.902344 19.902344 14.066406-14.070312-12.863282-12.863282 12.863282-12.867187zm0 0"/><path d="m156.285156 201.914062-14.070312 14.070313 12.867187 12.867187-12.867187 12.863282 14.070312 14.070312 19.898438-19.902344c3.882812-3.878906 3.882812-10.1875 0-14.066406zm0 0"/><path d="m90.042969 255.5625 19.914062-59.699219 18.875 6.296875-19.910156 59.699219zm0 0"/><path d="m587.050781 59.699219h-338.300781c-5.492188 0-9.949219 4.457031-9.949219 9.949219v199c0 5.492187 4.457031 9.949218 9.949219 9.949218h338.300781c5.492188 0 9.949219-4.457031 9.949219-9.949218v-199c0-5.492188-4.457031-9.949219-9.949219-9.949219zm-9.953125 199h-318.398437v-24.21875l89.351562-53.609375 87.113281 56.335937c2.992188 1.929688 6.785157 2.109375 9.949219.476563l72.027344-37.3125 59.957031 34.25zm0-46.992188-54.722656-31.292969c-2.9375-1.671874-6.515625-1.75-9.511719-.199218l-71.710937 37.144531-87.460938-56.566406c-3.191406-2.0625-7.273437-2.128907-10.527344-.171875l-84.464843 50.65625v-131.679688h318.398437zm0 0"/><path d="m472.625 169.148438c19.230469 0 34.824219-15.589844 34.824219-34.824219s-15.589844-34.824219-34.824219-34.824219-34.828125 15.589844-34.828125 34.824219 15.59375 34.824219 34.828125 34.824219zm0-49.746094c8.238281 0 14.925781 6.683594 14.925781 14.921875s-6.6875 14.925781-14.925781 14.925781-14.925781-6.6875-14.925781-14.925781 6.6875-14.921875 14.925781-14.921875zm0 0"/><path d="m99.5 328.351562v119.398438c0 5.492188 4.457031 9.949219 9.949219 9.949219h248.75c5.492187 0 9.949219-4.457031 9.949219-9.949219v-119.398438c0-5.492187-4.457032-9.949218-9.949219-9.949218h-248.75c-5.492188-.003906-9.949219 4.457031-9.949219 9.949218zm19.902344 9.949219h228.847656v99.5h-228.847656zm0 0"/><path d="m139.300781 358.199219h39.796875v19.902343h-39.796875zm0 0"/><path d="m199 358.199219h89.550781v19.902343h-89.550781zm0 0"/><path d="m308.449219 358.199219h19.902343v19.902343h-19.902343zm0 0"/><path d="m139.300781 398h119.398438v19.902344h-119.398438zm0 0"/><path d="m278.597656 398h49.75v19.902344h-49.75zm0 0"/><path d="m99.5 39.800781h19.902344v19.898438h-19.902344zm0 0"/><path d="m139.300781 39.800781h19.898438v19.898438h-19.898438zm0 0"/><path d="m179.097656 39.800781h19.902344v19.898438h-19.902344zm0 0"/><path d="m99.5 79.597656h119.402344v19.902344h-119.402344zm0 0"/><path d="m587.050781 358.199219h-189.050781c-5.492188 0-9.949219 4.460937-9.949219 9.949219v119.402343c0 5.492188 4.457031 9.949219 9.949219 9.949219h189.050781c5.492188 0 9.949219-4.457031 9.949219-9.949219v-119.402343c0-5.492188-4.457031-9.949219-9.949219-9.949219zm-9.953125 119.398437h-169.148437v-99.5h169.148437zm0 0"/><path d="m427.851562 398h19.898438v19.902344h-19.898438zm0 0"/><path d="m427.851562 437.800781h19.898438v19.898438h-19.898438zm0 0"/><path d="m467.648438 398h89.550781v19.902344h-89.550781zm0 0"/><path d="m467.648438 437.800781h89.550781v19.898438h-89.550781zm0 0"/><path d="m517.398438 298.5h19.902343v39.800781h-19.902343zm0 0"/></svg>
                        </div>
                        <form onSubmit={submitBoard}>
                            <div>
                                <Label>Name</Label>
                                <Input
                                    autoFocus
                                    value={name}
                                    placeholder={'How do you want to call the view?'}
                                    onChange={(e) => setName(e.target.value)}
                                />
                            </div>

                            <div style={{marginTop: 24, textAlign: 'right'}}>
                                <span
                                    style={{
                                        color: `rgba(${color}, .3)`,
                                        marginRight: 16
                                    }}
                                    onClick={() => {
                                        setName('');
                                        toggle();
                                    }}
                                >
                                    cancel
                                </span>
                                <Button type={'submit'}>create Template</Button>
                            </div>
                        </form>
                    </Columns>
                </ModalBody>
            </ModalContainer>
        </ModalWrapper>
    ) : null;
};

const mapStateToProps = state => ({
    boards: state.boards,
    projects: state.projects,
    tasks: state.tasks,
    checklists: state.checklists
});

const mapDispatchToProps = dispatch => ({
    add_template: template => dispatch({
        type: 'ADD_TEMPLATE',
        payload: template
    }),
});

export default connect(mapStateToProps, mapDispatchToProps)(CreateTemplateModal);